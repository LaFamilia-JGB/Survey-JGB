<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>🔐 התחברות</title>
    <link rel="stylesheet" href="assets/css/styles.css" />
    <style>
        /* ריפוד תחתון שלא יסתיר ה-nav */
        #nav-spacer {
            height: calc(var(--nav-h, 64px) + env(safe-area-inset-bottom, 0px));
        }

        .container {
            max-width: 520px;
            margin: auto;
            padding: 15px;
            padding-bottom: calc(var(--nav-h, 64px) + 16px);
        }

        .form-card {
            background: #1f1f1f;
            border: 1px solid #2b2b2b;
            border-radius: 12px;
            padding: 16px;
        }

        .msg {
            color: #ff6b6b;
            min-height: 1.2em;
            margin-top: 8px;
            text-align: center;
        }
    </style>
</head>

<body>
    <header class="topbar">🔐 התחברות</header>

    <main class="container">
        <div class="form-card">
            <form id="loginForm">
                <label>שם משתמש</label>
                <input id="u" autocomplete="username" required />
                <label>סיסמה</label>
                <input id="p" type="password" autocomplete="current-password" required />
                <button class="btn btn-primary" style="width:100%;margin-top:12px;">התחבר</button>
            </form>
            <div class="msg" id="msg"></div>
        </div>
    </main>

    <script src="assets/js/api.js"></script>
    <script>
        // שמירה על גובה spacer בהתאם ל-nav
        function setNavPadding() {
            const nav = document.getElementById('bottomNav');
            if (!nav) return;
            const h = Math.ceil(nav.getBoundingClientRect().height);
            document.documentElement.style.setProperty('--nav-h', h + 'px');
            const spacer = document.getElementById('nav-spacer');
            if (spacer) spacer.style.height = `calc(${h}px + env(safe-area-inset-bottom,0px))`;
        }
        addEventListener('DOMContentLoaded', setNavPadding);
        addEventListener('resize', setNavPadding);
        addEventListener('orientationchange', setNavPadding);

        // אם כבר מחוברים – הפניה אוטומטית
        (async function bootLogin() {
            const q = new URLSearchParams(location.search);
            const force = q.has('force') || q.get('force') === '1';
            const wantLogout = q.has('logout') || q.get('logout') === '1';

            if (wantLogout) {
                try { await API.logout(); } catch { }
            }

            // אם לא ביקשו force, ונראה שיש סשן תקין – ננתב אוטומטית
            if (!force) {
                try {
                    const me = await API.me();
                    if (me?.success) {
                        location.href = (me.role === 'admin') ? 'home.html' : 'home.html';
                        return;
                    }
                } catch { }
            }
            // אם force – פשוט נשארים בדף התחברות כרגיל
        })();


        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            msg.textContent = '';
            const btn = loginForm.querySelector('button'); btn.disabled = true;
            try {
                const r = await API.login(u.value.trim(), p.value);
                location.href = (r.role === 'admin') ? 'home.html' : 'home.html';
            } catch (err) {
                msg.textContent = err?.message || 'שגיאה בהתחברות';
            } finally {
                btn.disabled = false;
            }
        });
    </script>
</body>

</html>